image: alpine:latest

before_script:
  - if [ $PUBLIC ]; then export AUTH='--allow-unauthenticated'; else export AUTH=''; fi
  - if [ ! $TIMEOUT ]; then export TIMEOUT='2m'; fi
  - if [ ! $PROJECT_PATH ]; then export PROJECT_PATH='.'; fi

stages:
  - build
  - test
  - production

build:
  stage: build
  environment: production
  image: docker:stable
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
  script:
    - cd ${PROJECT_PATH}
    - docker build -t ${CI_PROJECT_PATH_SLUG} .

test:
  stage: test
  image: google/cloud-sdk:latest
  environment: test
  script:
    - printenv
    - export TMP_FILE=/tmp/${CI_PIPELINE_ID}.json
    - export TAG=gcr.io/${CLOUDSDK_CORE_PROJECT}/test-${CI_PROJECT_PATH_SLUG}:${CI_PIPELINE_ID}
    - echo ${GCLOUD_SERVICE_ACCOUNT} > ${TMP_FILE}
    - gcloud auth activate-service-account --key-file ${TMP_FILE}
    - gcloud config set project ${CLOUDSDK_CORE_PROJECT}
    - gcloud builds submit --tag ${TAG} ${PROJECT_PATH}
    - gcloud beta run deploy test-${CI_PROJECT_PATH_SLUG} --image ${TAG} --platform managed --region ${GCLOUD_PROJECT_REGION} ${AUTH} --timeout ${TIMEOUT}
    - gcloud beta run services add-iam-policy-binding test-${CI_PROJECT_PATH_SLUG} --member="allUsers" --role="roles/run.invoker" --region ${GCLOUD_PROJECT_REGION}
  only:
    refs:
      - branches
    variables:
      - $GCLOUD_PROJECT_REGION
  except:
    refs:
      - master

production:
  stage: production
  image: google/cloud-sdk:latest
  environment: production
  script:
    - printenv
    - export TMP_FILE=/tmp/${CI_PIPELINE_ID}.json
    - export TAG=gcr.io/${CLOUDSDK_CORE_PROJECT}/${CI_PROJECT_PATH_SLUG}:${CI_PIPELINE_ID}
    - echo ${GCLOUD_SERVICE_ACCOUNT} > ${TMP_FILE}
    - gcloud auth activate-service-account --key-file ${TMP_FILE}
    - gcloud config set project ${CLOUDSDK_CORE_PROJECT}
    - gcloud builds submit --tag ${TAG} ${PROJECT_PATH}
    - gcloud beta run deploy ${CI_PROJECT_PATH_SLUG} --image ${TAG} --platform managed --region ${GCLOUD_PROJECT_REGION} ${AUTH} --timeout ${TIMEOUT}
    - gcloud beta run services add-iam-policy-binding ${CI_PROJECT_PATH_SLUG} --member="allUsers" --role="roles/run.invoker" --region ${GCLOUD_PROJECT_REGION}
  only:
    refs:
      - master
    variables:
      - $GCLOUD_PROJECT_REGION
